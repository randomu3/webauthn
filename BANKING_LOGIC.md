# –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ù–ü–§ –°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑

## üîê –°–ª–æ–∂–Ω–∞—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üìã –û–±—â–∞—è —Å—Ö–µ–º–∞

```mermaid
flowchart TD
    A[üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç] --> B{üç™ –ï—Å—Ç—å Remember Token?}
    
    B -->|–ù–ï–¢| C[üîê –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å]
    B -->|–î–ê| D[‚ö° –ü–æ–∫–∞–∑–∞—Ç—å –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ + –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å]
    
    C --> E[üë§ –í–≤–æ–¥ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å]
    E --> F{‚úÖ –í–∫–ª—é—á–µ–Ω '–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è'?}
    
    F -->|–ù–ï–¢| G[üè† Dashboard \n(–±–µ–∑ PIN/WebAuthn)]
    F -->|–î–ê| H{üì± PIN –Ω–∞—Å—Ç—Ä–æ–µ–Ω?}
    
    H -->|–ù–ï–¢| I[‚öôÔ∏è Setup PIN \n(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)]
    H -->|–î–ê| G
    
    D --> J[üì± –í–≤–æ–¥ 6-–∑–Ω–∞—á–Ω–æ–≥–æ PIN]
    J --> K{üî¢ PIN –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?}
    
    K -->|–î–ê| L[üè† Dashboard]
    K -->|–ù–ï–¢| M{‚ùå –ü–æ–ø—ã—Ç–∫–∞ 1-2?}
    
    M -->|–î–ê| N[‚ö†Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É + –ø–æ–ø—ã—Ç–∫–∏]
    M -->|–ù–ï–¢ \n(3-—è –ø–æ–ø—ã—Ç–∫–∞)| O[üîí –°–ë–†–û–° –í–°–ï–ì–û \n‚Üí –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å]
    
    N --> J
    
    I --> P[üëÜ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å WebAuthn]
    P --> Q{üîê WebAuthn –Ω–∞—Å—Ç—Ä–æ–µ–Ω?}
    Q -->|–î–ê| R[üîê –í—Ö–æ–¥ –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É]
    Q -->|–ù–ï–¢| G
    
    R --> S{üëÜ WebAuthn —É—Å–ø–µ—à–Ω–æ?}
    S -->|–î–ê| L
    S -->|–ù–ï–¢ \n(–ª—é–±–∞—è –æ—à–∏–±–∫–∞)| T[üö® –ü–û–õ–ù–´–ô –°–ë–†–û–° \n‚Üí –õ–æ–≥–∏–Ω/–ü–∞—Ä–æ–ª—å]
```

### üîÑ –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### 1Ô∏è‚É£ **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ)**
```
üì± –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç
‚îî‚îÄ –í–∏–¥–∏—Ç: –¢–û–õ–¨–ö–û "üîê –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å"
‚îî‚îÄ –¢–∞–± "‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥" –°–ö–†–´–¢

üë§ –í–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
‚îú‚îÄ –ë–ï–ó "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è" ‚Üí Dashboard (–æ–±—ã—á–Ω–∞—è —Å–µ—Å—Å–∏—è)
‚îî‚îÄ –° "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è" ‚Üí Setup PIN ‚Üí Dashboard
```

#### 2Ô∏è‚É£ **Returning –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å—Ç—å remember token)**
```
üì± –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç
‚îî‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ remember token
‚îú‚îÄ –í–∞–ª–∏–¥–Ω—ã–π ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å "‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥" + –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
‚îî‚îÄ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –¢–æ–ª—å–∫–æ "üîê –õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å"

‚ö° –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω:
‚îú‚îÄ PIN –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (6 —Ü–∏—Ñ—Ä)
‚îú‚îÄ WebAuthn –∫–Ω–æ–ø–∫–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
‚îî‚îÄ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å" (fallback)
```

#### 3Ô∏è‚É£ **PIN —Å–∏—Å—Ç–µ–º–∞ (–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –ª–æ–≥–∏–∫–∞)**
```
üì± –í–≤–æ–¥ PIN —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
‚îú‚îÄ 1-—è –æ—à–∏–±–∫–∞ ‚Üí "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: 2"
‚îú‚îÄ 2-—è –æ—à–∏–±–∫–∞ ‚Üí "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π PIN. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: 1"  
‚îú‚îÄ 3-—è –æ—à–∏–±–∫–∞ ‚Üí üîí –ü–û–õ–ù–´–ô –°–ë–†–û–°:
‚îÇ   ‚îú‚îÄ PIN —Å–±—Ä–æ—à–µ–Ω
‚îÇ   ‚îú‚îÄ WebAuthn –æ—Ç–∫–ª—é—á–µ–Ω
‚îÇ   ‚îú‚îÄ Remember token —É–¥–∞–ª–µ–Ω
‚îÇ   ‚îî‚îÄ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
‚îî‚îÄ –£—Å–ø–µ—Ö ‚Üí Dashboard
```

#### 4Ô∏è‚É£ **WebAuthn —Å–∏—Å—Ç–µ–º–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)**
```
üëÜ –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É
‚îú‚îÄ –£—Å–ø–µ—Ö ‚Üí Dashboard
‚îî‚îÄ –õ–Æ–ë–ê–Ø –æ—à–∏–±–∫–∞ ‚Üí üö® –ú–ì–ù–û–í–ï–ù–ù–´–ô –ü–û–õ–ù–´–ô –°–ë–†–û–°:
    ‚îú‚îÄ PIN –æ—Ç–∫–ª—é—á–µ–Ω
    ‚îú‚îÄ WebAuthn –æ—Ç–∫–ª—é—á–µ–Ω  
    ‚îú‚îÄ Remember token —É–¥–∞–ª–µ–Ω
    ‚îú‚îÄ –°–µ—Å—Å–∏—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞
    ‚îú‚îÄ Security incident –ª–æ–≥–∏—Ä–æ–≤–∞–Ω
    ‚îî‚îÄ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
```

### üõ°Ô∏è –£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### üîµ **–£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
- –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–µ—Å—Å–∏—è
- –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤

#### üü° **–£—Ä–æ–≤–µ–Ω—å 2: –£–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø**  
- –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å + "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è"
- Remember token (30 –¥–Ω–µ–π)
- 6-–∑–Ω–∞—á–Ω—ã–π PIN –∫–æ–¥
- –ú–æ–±–∏–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

#### üü¢ **–£—Ä–æ–≤–µ–Ω—å 3: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- –í—Å–µ –∏–∑ –£—Ä–æ–≤–Ω—è 2
- WebAuthn –±–∏–æ–º–µ—Ç—Ä–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–±—Ä–æ—Å—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### üî¥ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–±—Ä–æ—Å—ã:**
1. **PIN: 3 –æ—à–∏–±–∫–∏** ‚Üí –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å PIN + WebAuthn + Remember token
2. **WebAuthn: 1 –æ—à–∏–±–∫–∞** ‚Üí –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ–≥–æ
3. **–í—ã—Ö–æ–¥ "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π"** ‚Üí –†—É—á–Ω–æ–π –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
4. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ remember token** ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞

#### üü† **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤:**
- –í—Å–µ –æ—à–∏–±–∫–∏ PIN/WebAuthn –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_log`
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è ‚Üí `security_incidents`
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚Üí `device_analytics`
- –°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí `session_analytics`

### üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### ‚úÖ **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
```bash
# –õ–æ–≥–∏–Ω –±–µ–∑ "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è"
curl -X POST -d '{"username":"testuser","password":"password123","remember_me":false}' \
     "auth_api.php?action=login"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: redirect_to="dashboard", needs_pin_setup=false
```

#### ‚úÖ **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è"**
```bash
# –õ–æ–≥–∏–Ω —Å "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è"
curl -X POST -d '{"username":"demo","password":"demo123","remember_me":true}' \
     "auth_api.php?action=login"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: redirect_to="setup_pin", remember_token —Å–æ–∑–¥–∞–Ω
```

#### ‚úÖ **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢–µ—Å—Ç PIN –ø–æ–ø—ã—Ç–æ–∫**
```bash
# –ù–µ–≤–µ—Ä–Ω—ã–π PIN (–ø–æ–ø—ã—Ç–∫–∞ 1)
curl -X POST -d '{"user_id":"demo_user_id","pin":"999999"}' \
     "auth_api.php?action=login-pin"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: "–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: 2"

# –ù–µ–≤–µ—Ä–Ω—ã–π PIN (–ø–æ–ø—ã—Ç–∫–∞ 3)
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å + –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```

#### ‚úÖ **–°—Ü–µ–Ω–∞—Ä–∏–π 4: WebAuthn –æ—à–∏–±–∫–∞**
```bash
# –û—à–∏–±–∫–∞ WebAuthn
curl -X POST -d '{"user_id":"demo_user_id","error_reason":"Biometric sensor failed"}' \
     "auth_api.php?action=webauthn-failure"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å + security incident
```

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
- **–£—Å–ø–µ—à–Ω—ã–µ –≤—Ö–æ–¥—ã** –ø–æ –º–µ—Ç–æ–¥–∞–º (–ø–∞—Ä–æ–ª—å/PIN/WebAuthn)
- **–ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** —Å –¥–µ—Ç–∞–ª—è–º–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–±—Ä–æ—Å—ã** —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏
- **Security incidents** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- **Device analytics** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

1. **–£–¥–æ–±—Å—Ç–≤–æ:** –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ñ–µ—Å—Ç–∫–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–±—Ä–æ—Å—ã –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å:** –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π
4. **–ê—É–¥–∏—Ç:** –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤
5. **Mobile-first:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
