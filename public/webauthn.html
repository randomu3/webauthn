<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Test - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .fingerprint {
            font-size: 48px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            font-size: 12px;
            overflow: auto;
            max-height: 200px;
        }
        
        .device-check {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîê WebAuthn</h1>
        
        <div class="device-check" id="deviceCheck">
            <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...</strong>
            <p id="deviceInfo"></p>
        </div>
        
        <div class="fingerprint">üëÜ</div>
        
        <button id="registerBtn" class="btn btn-primary">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
        
        <button id="loginBtn" class="btn btn-secondary">
            –í–æ–π—Ç–∏
        </button>
        
        <div class="status hidden" id="status"></div>
        
        <div class="hidden" id="debugInfo">
            <h3>Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <pre id="debugContent"></pre>
        </div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (jQuery)
        function checkDevice() {
            const userAgent = navigator.userAgent;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
            const supportsWebAuthn = !!window.PublicKeyCredential;
            
            let messages = [];
            
            if (!isMobile) {
                messages.push('‚ùå –ù–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
                $('#deviceCheck').css({
                    'background': '#f8d7da',
                    'color': '#721c24'
                });
            } else {
                messages.push('‚úÖ –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
                $('#deviceCheck').css({
                    'background': '#d4edda',
                    'color': '#155724'
                });
            }
            
            if (!supportsWebAuthn) {
                messages.push('‚ùå WebAuthn –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            } else {
                messages.push('‚úÖ WebAuthn –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
            
            $('#deviceInfo').html(messages.join('<br>'));
            
            return isMobile && supportsWebAuthn;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å (jQuery)
        function showStatus(message, type = 'info') {
            $('#status')
                .removeClass('success error info')
                .addClass(type)
                .text(message)
                .removeClass('hidden');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å debug (jQuery)
        function showDebug(data) {
            $('#debugContent').text(JSON.stringify(data, null, 2));
            $('#debugInfo').removeClass('hidden');
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ base64url
        function arrayBufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64url (–±–µ–∑ padding + –∑–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã)
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        function base64urlToArrayBuffer(base64url) {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64url –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—ã—á–Ω—ã–π base64
            let base64 = base64url
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            // –î–æ–±–∞–≤–ª—è–µ–º padding –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            while (base64.length % 4) {
                base64 += '=';
            }
            
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º base64url (jQuery)
        async function register() {
            if (!checkDevice()) {
                showStatus('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            
            try {
                showStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ü–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...', 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –æ–ø—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ (jQuery)
                const options = await $.ajax({
                    url: 'api.php?action=register-options',
                    method: 'POST',
                    contentType: 'application/json'
                });
                
                console.log('Server options:', options);
                
                if (!options.success) {
                    throw new Error(options.message);
                }
                
                showStatus('–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –ø–∞–ª–µ—Ü –∫ –¥–∞—Ç—á–∏–∫—É...', 'info');
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è WebAuthn API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º base64url
                const credentialCreationOptions = {
                    rp: options.rp,
                    user: {
                        id: base64urlToArrayBuffer(options.user.id),
                        name: options.user.name,
                        displayName: options.user.displayName
                    },
                    challenge: base64urlToArrayBuffer(options.challenge),
                    pubKeyCredParams: options.pubKeyCredParams,
                    timeout: options.timeout,
                    excludeCredentials: options.excludeCredentials.map(cred => ({
                        type: cred.type,
                        id: base64urlToArrayBuffer(cred.id)
                    })),
                    authenticatorSelection: options.authenticatorSelection,
                    attestation: options.attestation
                };
                
                console.log('WebAuthn options:', credentialCreationOptions);
                
                // –°–æ–∑–¥–∞–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const credential = await navigator.credentials.create({
                    publicKey: credentialCreationOptions
                });
                
                console.log('Created credential:', credential);
                
                if (!credential) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                }
                
                showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º base64url
                const verificationData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64url(credential.rawId),
                    type: credential.type,
                    response: {
                        clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
                        attestationObject: arrayBufferToBase64url(credential.response.attestationObject)
                    }
                };
                
                console.log('Sending to server:', verificationData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ jQuery
                const result = await $.ajax({
                    url: 'api.php?action=register-verify',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(verificationData)
                });
                
                console.log('Server response:', result);
                
                if (result.success) {
                    showStatus('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                } else {
                    throw new Error(result.message);
                }
                
                showDebug(result);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error.responseJSON?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                showDebug({ 
                    error: error.message || error.responseJSON?.message, 
                    debug: error.responseJSON?.debug || null 
                });
            }
        }
        
        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º base64url (jQuery)
        async function login() {
            if (!checkDevice()) {
                showStatus('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            
            try {
                showStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ü–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...', 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –æ–ø—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ (jQuery)
                const options = await $.ajax({
                    url: 'api.php?action=auth-options',
                    method: 'POST',
                    contentType: 'application/json'
                });
                
                console.log('Auth server options:', options);
                
                if (!options.success) {
                    throw new Error(options.message);
                }
                
                showStatus('–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –ø–∞–ª–µ—Ü –∫ –¥–∞—Ç—á–∏–∫—É...', 'info');
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è WebAuthn API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º base64url
                const credentialRequestOptions = {
                    challenge: base64urlToArrayBuffer(options.challenge),
                    timeout: options.timeout,
                    rpId: options.rpId,
                    allowCredentials: options.allowCredentials.map(cred => ({
                        type: cred.type,
                        id: base64urlToArrayBuffer(cred.id)
                    })),
                    userVerification: options.userVerification
                };
                
                console.log('Auth WebAuthn options:', credentialRequestOptions);
                
                // –ü–æ–ª—É—á–∞–µ–º assertion
                const assertion = await navigator.credentials.get({
                    publicKey: credentialRequestOptions
                });
                
                console.log('Got assertion:', assertion);
                
                if (!assertion) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å assertion');
                }
                
                showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º base64url
                const verificationData = {
                    id: assertion.id,
                    rawId: arrayBufferToBase64url(assertion.rawId),
                    type: assertion.type,
                    response: {
                        clientDataJSON: arrayBufferToBase64url(assertion.response.clientDataJSON),
                        authenticatorData: arrayBufferToBase64url(assertion.response.authenticatorData),
                        signature: arrayBufferToBase64url(assertion.response.signature),
                        userHandle: assertion.response.userHandle ? arrayBufferToBase64url(assertion.response.userHandle) : null
                    }
                };
                
                console.log('Sending auth to server:', verificationData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ jQuery
                const result = await $.ajax({
                    url: 'api.php?action=auth-verify',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(verificationData)
                });
                
                console.log('Auth server response:', result);
                
                if (result.success) {
                    showStatus('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    throw new Error(result.message);
                }
                
                showDebug(result);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message || error.responseJSON?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                showDebug({ 
                    error: error.message || error.responseJSON?.message, 
                    debug: error.responseJSON?.debug || null 
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (jQuery)
        $(document).ready(function() {
            checkDevice();
            
            $('#registerBtn').on('click', register);
            $('#loginBtn').on('click', login);
        });
    </script>
</body>
</html>
