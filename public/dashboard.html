<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –ù–ü–§ –°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/npf-theme.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .dashboard-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
        }
        
        .user-info {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .security-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .security-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        
        .security-card.enabled {
            border-left-color: #28a745;
        }
        
        .security-card.disabled {
            border-left-color: #dc3545;
        }
        
        .security-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        
        .security-card p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .security-actions {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .logout-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #e9ecef;
        }
        
        .logout-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-container">
            <div class="header">
                <div class="app-header">
                    <div class="app-logo">üè¢</div>
                    <div class="app-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
                    <div class="app-subtitle">–ù–ü–§ –°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑<br>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="user-info">
                <h2>üë§ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>!</h2>
                <div id="userDetails">
                    <p><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong> <span id="lastLogin">-</span></p>
                    <p><strong>–ú–µ—Ç–æ–¥ –≤—Ö–æ–¥–∞:</strong> <span id="loginMethod">-</span></p>
                    <p><strong>–í—Å–µ–≥–æ –≤—Ö–æ–¥–æ–≤:</strong> <span id="loginCount">-</span></p>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
            <div class="security-status">
                <div class="security-card" id="passwordCard">
                    <h3>üîê –ü–∞—Ä–æ–ª—å</h3>
                    <p>–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é</p>
                    <div class="status">‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω</div>
                </div>

                <div class="security-card" id="pinCard">
                    <h3>üì± PIN –∫–æ–¥</h3>
                    <p>6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞</p>
                    <div class="status" id="pinStatus">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                </div>

                <div class="security-card" id="webauthnCard">
                    <h3>üëÜ WebAuthn</h3>
                    <p>–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>
                    <div class="status" id="webauthnStatus">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="security-actions">
                <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é</h2>
                <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="setupWebAuthn" style="display: none;">
                        üîê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WebAuthn
                    </button>
                    
                    <button class="btn btn-warning" id="resetPin" style="display: none;">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å PIN
                    </button>
                    
                    <a href="webauthn.html" class="btn btn-primary">
                        üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å WebAuthn
                    </a>
                    
                    <button class="btn btn-warning" id="changePassword">
                        üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                </div>
            </div>

            <!-- –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã -->
            <div class="logout-section">
                <h3>üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—ã—Ö–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:</p>
                
                <div class="logout-options">
                    <button class="btn btn-primary" id="simpleLogout">
                        –û–±—ã—á–Ω—ã–π –≤—ã—Ö–æ–¥
                    </button>
                    
                    <button class="btn btn-danger" id="secureLogout">
                        –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ (—Å–±—Ä–æ—Å PIN –∏ WebAuthn)
                    </button>
                </div>
                
                <div style="margin-top: 15px; font-size: 14px; color: #666;">
                    <strong>–û–±—ã—á–Ω—ã–π –≤—ã—Ö–æ–¥:</strong> –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞<br>
                    <strong>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥:</strong> –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="status" class="status hidden"></div>

            <!-- Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div id="debug" class="debug hidden"></div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            loadUserInfo();
            setupEventHandlers();
        });

        function setupEventHandlers() {
            $('#simpleLogout').on('click', () => logout(false));
            $('#secureLogout').on('click', () => logout(true));
            $('#setupWebAuthn').on('click', setupWebAuthn);
            $('#resetPin').on('click', resetPin);
            $('#changePassword').on('click', changePassword);
        }

        function loadUserInfo() {
            $.ajax({
                url: 'auth_api.php?action=status',
                method: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    if (response.success && response.authenticated && response.user) {
                        displayUserInfo(response.user, response.session_info);
                        updateSecurityStatus(response.user);
                    } else {
                        // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥
                        window.location.href = 'login.html';
                    }
                },
                error: function() {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            });
        }

        function displayUserInfo(user, sessionInfo) {
            $('#userName').text(user.display_name || user.username);
            
            if (user.last_login) {
                const lastLogin = new Date(user.last_login).toLocaleString('ru-RU');
                $('#lastLogin').text(lastLogin);
            }
            
            $('#loginMethod').text(getLoginMethodText(user.last_login_method));
            $('#loginCount').text(user.login_count || 0);
        }

        function getLoginMethodText(method) {
            const methods = {
                'PASSWORD': '–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å',
                'PIN': 'PIN –∫–æ–¥',
                'WEBAUTHN': 'WebAuthn (–±–∏–æ–º–µ—Ç—Ä–∏—è)',
                'REMEMBER_TOKEN': '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥'
            };
            return methods[method] || method || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
        }

        function updateSecurityStatus(user) {
            // PIN —Å—Ç–∞—Ç—É—Å
            if (user.pin_enabled) {
                $('#pinCard').addClass('enabled').removeClass('disabled');
                $('#pinStatus').html('‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω').css('color', '#28a745');
                $('#resetPin').show();
            } else {
                $('#pinCard').addClass('disabled').removeClass('enabled');
                $('#pinStatus').html('‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω').css('color', '#dc3545');
            }

            // WebAuthn —Å—Ç–∞—Ç—É—Å
            if (user.webauthn_enabled) {
                $('#webauthnCard').addClass('enabled').removeClass('disabled');
                $('#webauthnStatus').html('‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω').css('color', '#28a745');
            } else {
                $('#webauthnCard').addClass('disabled').removeClass('enabled');
                $('#webauthnStatus').html('‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω').css('color', '#dc3545');
                $('#setupWebAuthn').show();
            }
        }

        function logout(resetSecurity) {
            const logoutType = resetSecurity ? '–±–µ–∑–æ–ø–∞—Å–Ω—ã–π' : '–æ–±—ã—á–Ω—ã–π';
            
            if (resetSecurity) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ —É–¥–∞–ª–∏—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞ (PIN –∏ WebAuthn).')) {
                    return;
                }
            }
            
            showStatus(`üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ${logoutType} –≤—ã—Ö–æ–¥...`, 'info');
            
            $.ajax({
                url: 'auth_api.php?action=logout',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    reset_security: resetSecurity
                }),
                success: function(response) {
                    if (response.success) {
                        showStatus(`‚úÖ ${logoutType.charAt(0).toUpperCase() + logoutType.slice(1)} –≤—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω`, 'success');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1000);
                    } else {
                        showStatus('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error');
                    }
                },
                error: function() {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error');
                }
            });
        }

        function setupWebAuthn() {
            window.location.href = 'webauthn.html?mode=setup';
        }

        function resetPin() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å PIN –∫–æ–¥? –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.')) {
                return;
            }
            
            $.ajax({
                url: 'auth_api.php?action=reset-security',
                method: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        showStatus('‚úÖ PIN –∫–æ–¥ —Å–±—Ä–æ—à–µ–Ω', 'success');
                        setTimeout(() => {
                            window.location.href = 'setup.html';
                        }, 1000);
                    } else {
                        showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ PIN', 'error');
                    }
                },
                error: function() {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ PIN', 'error');
                }
            });
        }

        function changePassword() {
            showStatus('üîß –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
        }

        function showStatus(message, type = 'info') {
            $('#status')
                .removeClass('hidden success error info')
                .addClass(type)
                .text(message)
                .show();
        }
    </script>
</body>
</html>
